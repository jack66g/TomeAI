<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Synapse AI OS</title>
  <style>
    /* === 1. åŸºç¡€æ ·å¼ === */
    body {
      margin: 0;
      padding: 0;
      background-color: #1e1e1e;
      color: #e0e0e0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* === 2. é¡¶éƒ¨çŠ¶æ€æ  === */
    #status-bar {
      padding: 10px 20px;
      background-color: #252526;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #avatar {
      width: 12px;
      height: 12px;
      background-color: #00ff88;
      border-radius: 50%;
      box-shadow: 0 0 10px #00ff88;
      animation: pulse 3s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
    #status-text {
      font-size: 12px;
      color: #888;
    }

    /* === 3. èŠå¤©è®°å½•åŒºåŸŸ === */
    #chat-history {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    #chat-history::-webkit-scrollbar { width: 8px; }
    #chat-history::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

    /* æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
    .message {
      max-width: 80%;
      padding: 10px 15px;
      border-radius: 12px;
      line-height: 1.5;
      font-size: 14px;
      word-wrap: break-word;
    }
    .user-message {
      align-self: flex-end;
      background-color: #007acc;
      color: white;
      border-bottom-right-radius: 2px;
    }
    .ai-message {
      align-self: flex-start;
      background-color: #333;
      color: #ddd;
      border-bottom-left-radius: 2px;
    }
    .thinking-process {
      align-self: flex-start;
      font-size: 12px;
      color: #888;
      font-style: italic;
      margin-left: 5px;
    }

    /* === 4. åº•éƒ¨è¾“å…¥åŒº (å…³é”®éƒ¨åˆ†) === */
    #input-area {
      padding: 20px;
      background-color: #252526;
      display: flex;
      gap: 10px;
      border-top: 1px solid #333;
    }
    #user-input {
      flex: 1;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #1e1e1e;
      color: white;
      outline: none;
      font-size: 14px;
    }
    #user-input:focus {
      border-color: #007acc;
    }
    
    /* âœ¨ å‘é€æŒ‰é’®æ ·å¼ âœ¨ */
    #send-btn {
      padding: 0 20px;
      background-color: #007acc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    #send-btn:hover {
      background-color: #005f9e;
    }
    #send-btn:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>

  <div id="status-bar">
    <div id="avatar"></div>
    <div id="status-text">åˆå§‹åŒ–ä¸­...</div>
  </div>

  <div id="chat-history">
    <div class="message ai-message">ä½ å¥½ï¼æˆ‘æ˜¯ Synapse æ™ºèƒ½åŠ©æ‰‹ã€‚<br>è¾“å…¥ "åˆ›å»ºæ–‡ä»¶" å³å¯å¼€å§‹ã€‚</div>
  </div>

  <div id="input-area">
    <input type="text" id="user-input" placeholder="è¾“å…¥æŒ‡ä»¤ (æ”¯æŒå›è½¦é»˜è®¤)..." autofocus />
    <button id="send-btn">å‘é€</button>
  </div>

  <script>
    const { invoke } = window.__TAURI__.core;
    const { Command } = window.__TAURI__.shell;

    const chatHistory = document.getElementById('chat-history');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const statusText = document.getElementById('status-text');
    const avatar = document.getElementById('avatar');

    let backendProcess = null;

    // === 1. å¯åŠ¨åç«¯ ===
    async function startBackend() {
      console.log('æ­£åœ¨è¿æ¥ç¥ç»ä¸­æ¢...');
      const cmd = Command.sidecar('synapse');

      cmd.stdout.on('data', (line) => {
        const cleanLine = line.trim();
        if (!cleanLine) return;

        // è·¯ç”±ä¸åŒç±»å‹çš„æ¶ˆæ¯
        if (cleanLine.startsWith('[THINK]')) {
            appendThinking(cleanLine.substring(8));
            updateStatus("æ€è€ƒä¸­...", true);
        } else if (cleanLine.startsWith('[RESULT]')) {
            appendAIMessage(cleanLine.substring(9));
            updateStatus("å°±ç»ª", false);
        } else if (cleanLine.startsWith('[ERROR]')) {
            appendError(cleanLine.substring(8));
            updateStatus("å°±ç»ª", false);
        } else {
            // âœ… å¤„ç†æ™®é€šæç¤º (å¦‚ï¼šè¯·é—®æ–‡ä»¶åï¼Ÿ)
            appendAIMessage(cleanLine);
            updateStatus("ç­‰å¾…è¾“å…¥...", false);
        }
      });

      cmd.stderr.on('data', line => console.error(`Backend ERR: ${line}`));
      
      cmd.on('close', () => {
          appendError("è¿æ¥å·²æ–­å¼€");
          updateStatus("ç¦»çº¿", false);
          avatar.style.backgroundColor = '#ff4444';
      });

      try {
          backendProcess = await cmd.spawn();
          console.log('è¿æ¥æˆåŠŸ, PID:', backendProcess.pid);
          updateStatus("å°±ç»ª", false);
      } catch (e) {
          appendError("å¯åŠ¨å¤±è´¥: " + e);
          updateStatus("é”™è¯¯", false);
      }
    }

    // === 2. å‘é€æ¶ˆæ¯ (æ”¯æŒæŒ‰é’®å’Œå›è½¦) ===
    async function sendMessage() {
      const rawText = userInput.value;
      
      // âœ… å…è®¸ç©ºå›è½¦ï¼šå¦‚æœæ˜¯ç©ºçš„ï¼Œå‘ä¸€ä¸ªç©ºæ ¼è¿‡å»è§¦å‘é»˜è®¤å€¼
      const textToSend = rawText.trim() === "" ? " " : rawText.trim();

      if (!backendProcess) return;

      // UI æ˜¾ç¤º
      if (rawText.trim() === "") {
          appendUserMessage("â†©ï¸ (é»˜è®¤)");
      } else {
          appendUserMessage(rawText.trim());
      }
      
      userInput.value = '';

      try {
          await backendProcess.write(textToSend + '\n');
          updateStatus("å‘é€ä¸­...", true);
      } catch (e) {
          appendError("å‘é€å¤±è´¥: " + e);
      }
    }

    // === 3. UI è¾…åŠ©å‡½æ•° ===
    function appendUserMessage(text) {
      const d = document.createElement('div');
      d.className = 'message user-message';
      d.textContent = text;
      chatHistory.appendChild(d);
      scrollToBottom();
    }

    function appendAIMessage(text) {
      const d = document.createElement('div');
      d.className = 'message ai-message';
      d.innerHTML = text.replace(/\n/g, '<br>');
      chatHistory.appendChild(d);
      scrollToBottom();
    }

    function appendThinking(text) {
        const d = document.createElement('div');
        d.className = 'thinking-process';
        d.textContent = 'ğŸ§  ' + text;
        chatHistory.appendChild(d);
        scrollToBottom();
    }

    function appendError(text) {
        const d = document.createElement('div');
        d.className = 'thinking-process';
        d.style.color = '#ff6b6b';
        d.textContent = 'âš ï¸ ' + text;
        chatHistory.appendChild(d);
        scrollToBottom();
    }

    function scrollToBottom() {
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function updateStatus(text, isBusy) {
        statusText.textContent = text;
        if (isBusy) avatar.style.animationDuration = '0.5s';
        else avatar.style.animationDuration = '3s';
    }

    // === 4. äº‹ä»¶ç»‘å®š (è®©æŒ‰é’®å’Œå›è½¦ä¸€èµ·ç”¨) ===
    sendBtn.addEventListener('click', sendMessage); // ç»‘å®šç‚¹å‡»
    userInput.addEventListener('keypress', (e) => { 
        if (e.key === 'Enter') sendMessage();       // ç»‘å®šå›è½¦
    });

    // å¯åŠ¨ï¼
    window.addEventListener('DOMContentLoaded', startBackend);
  </script>
</body>
</html>
